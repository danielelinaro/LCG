#!/bin/bash

#
# Write .cclamprc file
# Author: Daniele Linaro, January 2013
#

print_help()
{
    echo
    echo "Write .cclamprc file"
    echo
    echo "Usage : `basename $0` [options <value>]"
    echo
    echo "where options are:"
    echo
    echo "   -h   display this help message and exit"
    echo "   -i   write input entry"
    echo "   -o   write output entry"
    echo "   -c   channel number"
    echo "   -s   subdevice number (default $AI_SUBDEVICE for AI, $AO_SUBDEVICE for AO)"
    echo "   -f   conversion factor (default $AI_CONVERSION_FACTOR for AI, $AO_CONVERSION_FACTOR for AO)"
    echo "   -u   units (default $INPUT_UNITS for AI, $OUTPUT_UNITS for AO)"
    echo "   -e   erase existing file (default no)"
    echo "   -r   ground reference (default $GROUND_REF)"
    echo
}

rcfile=$HOME/.cclamprc
input="no"
output="no"
append="yes"
subdevice=
channel=
conversion_factor=
units=
reference=$GROUND_REFERENCE
while getopts ":eios:c:f:u:r:h" opt ; do
    case $opt in
	e)
	    append="no"
	    ;;
	i)
	    input="yes"
	    ;;
	o)
	    output="yes"
	    ;;
	s)
	    subdevice=$OPTARG
	    ;;
	c)
	    channel=$OPTARG
	    ;;
	f)
	    conversion_factor=$OPTARG
	    ;;
	u)
	    units=$OPTARG
	    ;;
	r)
	    reference=$OPTARG
	    ;;
	h)
	    print_help
	    exit 0
	    ;;
	\?)
	    echo "Invalid option: -$OPTARG."
	    echo "Type `basename $0` -h for help."
	    exit 1
	    ;;
    esac
done

if [ $input == "no" -a $output == "no" ] ; then
    echo "You must specify one of input or output (with -i or -o respectively)."
    exit 1
fi

if [ $input == "yes" -a $output == "yes" ] ; then
    echo "You must specify either input or output (with -i or -o respectively)."
    exit 1
fi

if [ -z "${channel:-}" ] ; then
    echo "You must specify the channel."
    exit 1
fi

if [ $append == "no" ] ; then
    rm -f $rcfile
fi

touch $rcfile

if [ $input == "yes" ] ; then
    n=`grep AnalogInput $rcfile | wc -l`
    header="[AnalogInput$n]"
    if [ -z "${subdevice:-}" ] ; then
	subdevice=$AI_SUBDEVICE
    fi
    if [ -z "${conversion_factor:-}" ] ; then
	conversion_factor=$AI_CONVERSION_FACTOR
    fi
    if [ -z "${units:-}" ] ; then
	units=$INPUT_UNITS
    fi
else
    n=`grep AnalogOutput $rcfile | wc -l`
    header="[AnalogOutput$n]"
    if [ -z "${subdevice:-}" ] ; then
	subdevice=$AO_SUBDEVICE
    fi
    if [ -z "${conversion_factor:-}" ] ; then
	conversion_factor=$AO_CONVERSION_FACTOR
    fi
    if [ -z "${units:-}" ] ; then
	units=$OUTPUT_UNITS
    fi
fi

echo $header >> $rcfile
echo "device = /dev/comedi0" >> $rcfile
echo "range = [-10,+10]" >> $rcfile
echo "subdevice = $subdevice" >> $rcfile
echo "channel = $channel" >> $rcfile
echo "conversionFactor = $conversion_factor" >> $rcfile
echo "reference = $reference" >> $rcfile
echo "units = $units" >> $rcfile
echo "" >> $rcfile
