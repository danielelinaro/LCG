#!/bin/sh

#
# ZAP protocol
# Author: Daniele Linaro, January 2013
#

print_help()
{
    echo
    echo "ZAP protocol."
    echo
    echo "Usage : `basename $0` [options <value>]"
    echo
    echo "where options are:"
    echo
    echo "   -h   display this help message and exit"
    echo "   -a   specify the amplitude of the stimulation (default 100 pA)"
    echo "   -o   specify the offset of the stimulation (default 0 pA)"
    echo "   -n   specify the number of repetitions (default 5)"
    echo "   -i   specify the interval between repetitions (default 10 sec)"
    echo "   -d   specify the duration of each trial (default 10 sec)"
    echo "   -f   specify the starting frequency (default 0.1 Hz)"
    echo "   -F   specify the end frequency (default 100 Hz)"
    echo "   -I   specify the input channel (default 0)"
    echo "   -O   specify the output channel (default 0)"
    echo
}

reps=5
amplitude=100
offset=0
interval=10
duration=10
fstart=0.1
fstop=100
ai=0
ao=0
while getopts ":a:o:n:i:d:f:F:I:O:h" opt ; do
    case $opt in
	a)
	    amplitude=$OPTARG
	    ;;
	o)
	    offset=$OPTARG
	    ;;
	n)
	    reps=$OPTARG
	    ;;
	i)
	    interval=$OPTARG
	    ;;
	d)
	    duration=$OPTARG
	    ;;
	f)
	    fstart=$OPTARG
	    ;;
	F)
	    fstop=$OPTARG
	    ;;
	I)
	    ai=$OPTARG
	    ;;
	O)
	    ao=$OPTARG
	    ;;
	h)
	    print_help
	    exit 0
	    ;;
	\?)
	    echo "Invalid option: -$OPTARG."
	    echo "Type `basename $0` -h for help."
	    exit 1
	    ;;
    esac
done

if [ -z "${PROTOCOLS_PATH:-}" ] ; then
    origstimfile=$HOME/protocols/zap/zap.stim
else
    origstimfile=$PROTOCOLS_PATH/zap/zap.stim
fi

if [ ! -f $origstimfile ] ; then
    echo "`basename $0`: $origstimfile: No such file."
    exit 1
fi

stimfile=/tmp/zap.stim

sed -e "s/T/$duration/" -e "s/I0/$offset/" -e "s/I/$amplitude/" -e "s/f/$fstart/" -e "s/F/$fstop/" $origstimfile > $stimfile
lcg kernel -I $ai -O $ao
lcg vcclamp -f $stimfile -n $reps -i $interval
rm $stimfile
