#!/bin/bash

#
# Electrode kernel computation
# Author: Daniele Linaro, April 2012
#

print_help()
{
    echo
    echo "Electrode kernel computation"
    echo
    echo "Usage : `basename $0` [options <value>]"
    echo
    echo "where options are:"
    echo
    echo "   -h   display this help message and exit"
    echo "   -d   specify the duration of the white noise stimulation in seconds (default 10)"
    echo "   -i   specify the input channel (default 0)"
    echo "   -o   specify the output channel (default 0)"
    echo "   -F   specify the sampling frequency (default 20000)"
    echo
}

append_channel=0
duration=10
ai=0
ao=0
F=20000
while getopts ":d:i:o:F:h" opt ; do
    case $opt in
	F)
	    F=$OPTARG
	    ;;
	d)
	    duration=$OPTARG
	    ;;
	i)
	    ai=$OPTARG
	    append_channel=1
	    ;;
	o)
	    ao=$OPTARG
	    append_channel=1
	    ;;
	h)
	    print_help
	    exit 0
	    ;;
	\?)
	    echo "Invalid option: -$OPTARG."
	    echo "Type `basename $0` -h for help."
	    exit 1
	    ;;
    esac
done

if [ -z "${PROTOCOLS_PATH:-}" ] ; then
    origstimfile=$HOME/protocols/white_noise/white_noise_short.stim
else
    origstimfile=$PROTOCOLS_PATH/white_noise/white_noise_short.stim
fi

if [ -z "${CONFIGURATIONS_PATH:-}" ] ; then
    cclamprc=$HOME/configurations/cclamprc
else
    cclamprc=$CONFIGURATIONS_PATH/cclamprc
fi

if [ -f $cclamprc ] ; then
    sed -e "s/AI/$ai/" -e "s/AO/$ao/" $cclamprc > $HOME/.cclamprc
fi

stimfile=/tmp/white_noise.stim

sed -e 's/^10/'$duration'/' $origstimfile > $stimfile
cclamp -f $stimfile -F $F
datafile=`ls -lrth | tail -1 | awk '{ print $9 }'`
extract_kernels.py $datafile
kernelfile=${datafile%.h5}_kernel.dat
rm -f kernel.dat
if [ $append_channel -eq 0 ] ; then
    ln -s $kernelfile kernel.dat
else
    ln -s $kernelfile kernel-$ai-$ao.dat
fi
rm $stimfile
