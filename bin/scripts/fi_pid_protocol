#!/bin/bash

#
# f-I curve protocol with the usage of a PID controller
# Author: Daniele Linaro, September 2012
#

function print_help
{
    echo
    echo "f-I curve protocol with the usage of a PID controller."
    echo
    echo "Usage : `basename $0` [options <value>]"
    echo
    echo "where options are:"
    echo
    echo "   -h   display this help message and exit"
    echo "   -c   specify the configuration file (default fI_PID.xml)"
    echo "   -f   specify the frequency stimulus file (default frequency.stim)"
    echo "   -F   specify the maximal frequency (default 30 Hz)"
    echo "   -a   specify the initial amplitude of the current (default 300 pA)"
    echo "   -p   specify the proportional gain of the controller (default 0.01)"
    echo "   -i   specify the integral gain of the controller (default 1)"
    echo "   -d   specify the derivative gain of the controller (default 0)"
    echo "   -t   specify the time constant of the frequency estimator (default 1 sec)"
    echo "   -T   specify the duration of the ramp (default 30 sec)"
    echo "   -n   specify the number of batches (default 2)"
    echo "   -w   specify the interval between batches (default 60 sec)"
    echo "   -I   specify the input channel (default 0)"
    echo "   -O   specify the output channel (default 0)"
    echo
}

config_file=fI_PID.xml
frequency_file=frequency.stim
F=30
I0=300
gp=0.01
gi=1
gd=0
tau=1
T=30
reps=2
interval=60
F0=5
ai=0
ao=0
while getopts ":c:f:F:a:p:i:d:t:T:n:w:I:O:h" opt ; do
    case $opt in
	c)
	    config_file=$OPTARG
	    ;;
	f)
	    frequency_file=$OPTARG
	    ;;
	F)
	    F=$OPTARG
	    ;;
	a)
	    I0=$OPTARG
	    ;;
	p)
	    gp=$OPTARG
	    ;;
	i)
	    gi=$OPTARG
	    ;;
	d)
	    gd=$OPTARG
	    ;;
	t)
	    tau=$OPTARG
	    ;;
	T)
	    T=$OPTARG
	    ;;
	n)
	    reps=$OPTARG
	    ;;
	w)
	    interval=$OPTARG
	    ;;
	I)
	    ai=$OPTARG
	    ;;
	O)
	    ao=$OPTARG
	    ;;
	h)
	    print_help
	    exit 0
	    ;;
	\?)
	    echo "Invalid option: -$OPTARG."
	    echo "Type `basename $0` -h for help."
	    exit 1
	    ;;
    esac
done

let F=$F-$F0
if [ -z "${PROTOCOLS_PATH:-}" ] ; then
    stimdir=$HOME/protocols/fclamp
else
    stimdir=$PROTOCOLS_PATH/fclamp
fi

if [ -z "${CONFIGURATIONS_PATH:-}" ] ; then
    configdir=$HOME/configurations
else
    configdir=$CONFIGURATIONS_PATH
fi

sed -e 's/T/'$T'/' -e 's/F/'$F'/' $stimdir/$frequency_file > $frequency_file
sed -e 's/AI/'$ai'/' -e 's/AO/'$ao'/' -e 's/GP/'$gp'/' -e 's/GI/'$gi'/' -e 's/GD/'$gd'/' -e 's/I0/'$I0'/' -e 's/TAU/'$tau'/' -e 's/F0/'$F0'/' -e 's/frequency\.stim/'$frequency_file'/' -e 's/TEND/'$T'/' $configdir/$config_file > $config_file

kernel_protocol -I $ai -O $ao
lcg -c $config_file -n $reps -i $interval

